# 故障排除指南

## 连接问题

### 🔴 问题：喷码机无响应，命令超时

**症状**：
- 发送命令后15秒超时
- 日志显示命令已发送但无响应
- 错误信息：`Response timeout`
- 通信日志中只有"发送"没有"接收"

**最常见原因：机号不匹配** ⚠️

喷码机通过机号来识别命令是否发给自己。如果发送的机号与喷码机配置的机号不一致，喷码机会忽略所有命令。

**解决方法**：

1. **确认喷码机的IP地址**
   ```bash
   # 在树莓派上执行
   ping 169.254.59.119
   ```

2. **计算正确的机号**
   - IP地址：`169.254.59.119`
   - 机号 = 最后一个字节 = `119`（十进制）= `0x77`（十六进制）

3. **在设置中配置正确的机号**
   - 点击右上角设置图标 ⚙️
   - 在"机号"字段输入 `119`
   - 点击"保存设置"
   - 系统会自动断开并重新连接

4. **验证机号是否正确**
   - 查看通信日志中的"发送"部分
   - 点击展开查看详细信息
   - 检查"机号"字段应显示 `0x77 (机号119)`
   - 如果显示 `0x00 (机号0)`，说明配置未生效

**调试步骤**：

```
✅ 正确的命令格式（以握手命令为例）：
1B 02 77 00 1B 03 BE
      ^^
      机号77（十进制119）

❌ 错误的命令格式：
1B 02 00 00 1B 03 41
      ^^
      机号00会被喷码机忽略
```

**常见错误原因**：
- 使用默认值0而未配置
- 配置后未点击"保存设置"
- 保存后未重新连接喷码机
- 输入了IP地址最后一个字节的十六进制值（应该输入十进制）

---

### 问题：网络连接失败

**症状**：
- 点击"连接"按钮无反应
- 错误：`TCP connection not available`
- 错误：`Connection refused`

**解决方法**：

1. **检查网络连通性**
   ```bash
   # 测试网络连接
   ping 169.254.59.119
   
   # 测试TCP端口
   telnet 169.254.59.119 139
   ```

2. **检查IP和端口配置**
   - 确认IP地址正确
   - 确认端口号正确（通常是139）
   - 确认喷码机已开机并连接到网络

3. **检查网络配置**
   ```bash
   # 查看树莓派网络配置
   ifconfig
   
   # 查看路由表
   route -n
   ```

4. **检查防火墙**
   ```bash
   # 临时关闭防火墙测试
   sudo ufw disable
   ```

---

### 问题：连接后自动断开

**症状**：
- 连接成功后立即断开
- 日志显示 `Connection closed by printer`

**可能原因**：
1. 喷码机拒绝连接（机号不匹配）
2. 发送了错误格式的命令
3. 喷码机处于锁定状态

**解决方法**：
1. 检查机号配置
2. 查看最后发送的命令是否正确
3. 尝试发送解锁命令（0x03）

---

## 打印问题

### 问题：二维码打印不出来（但文本可以）

**症状**：
- 发送二维码命令成功（状态码0x00）
- 启动喷印成功
- 但实际打印时没有输出二维码

**可能原因**：

1. **线条宽度太小**
   - 线条宽度范围：3-15
   - 推荐值：6-10
   - 值太小会导致喷头无法正确渲染

   **解决方法**：
   - 在"内容设置"中增加"线条宽度"值
   - 尝试设置为8-10

2. **容错级别设置不当**
   - L级容错：适合短内容
   - H级容错：适合长内容和复杂环境

   **解决方法**：
   - 对于URL链接，建议使用H级
   - 如果二维码尺寸过大，可尝试降低容错级别

3. **坐标位置超出打印区域**
   - X/Y坐标可能超出喷头打印范围

   **解决方法**：
   - 尝试设置 X=0, Y=0（默认位置）
   - 查看喷码机手册确认打印区域范围

4. **条码尺寸设置不当**
   - Auto(0)有时可能不适用

   **解决方法**：
   - 尝试手动设置条码尺寸为1-8
   - QRcode推荐使用2-4

---

### 问题：发送打印成功但无输出

**检查清单**：

1. ✅ **是否先发送了内容？**
   - 必须先点击"发送打印"发送内容
   - 查看日志确认命令0x1C和0x01都成功

2. ✅ **是否启动了喷印？**
   - 发送内容后必须点击"启动喷印"
   - 状态栏显示"打印中"

3. ✅ **是否有触发信号？**
   - 检查光眼是否工作
   - 或者使用"触发喷印"按钮手动触发

4. ✅ **墨盒是否有余量？**
   - 点击刷新查看墨盒余量
   - 余量低于10%时可能无法正常打印

5. ✅ **喷码机是否处于正常状态？**
   - 使用调试面板发送命令0x14查询报警状态
   - 检查是否有错误代码

---

### 问题：打印内容位置不对

**解决方法**：

1. **调整X/Y坐标**
   - X坐标：水平位置（0-1000）
   - Y坐标：垂直位置（0-150，取决于喷头高度）

2. **检查旋转角度**
   - 0° = 正常
   - 90° = 顺时针旋转90度
   - 180° = 倒置
   - 270° = 逆时针旋转90度

3. **使用导轨控制调整喷头位置**
   - 使用左右箭头移动导轨
   - 微调喷头相对于产品的位置

---

## 硬件问题

### 问题：步进电机不工作

**症状**：
- 点击移动按钮无反应
- 电机不转动或抖动

**解决方法**：

1. **检查pigpiod服务**
   ```bash
   # 检查服务状态
   sudo systemctl status pigpiod
   
   # 启动服务
   sudo pigpiod
   
   # 设置开机自启
   sudo systemctl enable pigpiod
   ```

2. **验证GPIO引脚**
   ```bash
   # 安装gpio工具
   sudo apt-get install wiringpi
   
   # 查看所有GPIO状态
   gpio readall
   
   # 测试引脚输出
   gpio -g mode 20 out
   gpio -g write 20 1
   gpio -g write 20 0
   ```

3. **检查硬件连接**
   - ✅ 5V电源线连接正确
   - ✅ GND接地线连接正确
   - ✅ DIR/STEP/ENABLE引脚连接正确
   - ✅ 电机驱动器供电正常

4. **检查引脚配置**
   - 在设置面板检查GPIO引脚号
   - 确认与实际接线一致
   - 树莓派引脚编号使用BCM模式（GPIO编号）

---

### 问题：CPU温度显示为0

**症状**：
- 状态栏CPU温度一直显示0°C

**解决方法**：

1. **验证温度文件存在**
   ```bash
   # 读取温度
   cat /sys/class/thermal/thermal_zone0/temp
   # 应该输出类似 54321 的数值（表示54.321°C）
   ```

2. **检查文件权限**
   ```bash
   ls -l /sys/class/thermal/thermal_zone0/temp
   # 应该有读取权限
   ```

3. **检查是否在树莓派上运行**
   - 此功能只在树莓派上有效
   - 其他Linux系统可能没有此文件

4. **查看服务器日志**
   ```bash
   npm run dev
   # 查看是否有 "[v0] CPU Temperature: XX.X °C" 日志
   ```

---

### 问题：墨盒余量显示不准确

**解决方法**：

1. **手动刷新**
   - 点击墨盒余量旁的刷新按钮 🔄
   - 等待2-3秒查看更新结果

2. **检查连接**
   - 确认喷码机已连接
   - 查看通信日志确认命令0x26执行成功

3. **重新安装墨盒**
   - 取出墨盒重新安装
   - 检查墨盒芯片接触是否良好

---

## 协议问题

### 状态码对照表

| 状态码 | 十六进制 | 说明 | 解决方法 |
|--------|----------|------|----------|
| 0 | 0x00 | 成功 - 无错误 | - |
| 1 | 0x01 | 喷码机错误 | 检查设备状态 |
| 8 | 0x08 | 无效校验码 | 检查数据完整性 |
| 10 | 0x0A | 解析失败，未知模块类型 | 检查数据格式 |
| 11 | 0x0B | 二维码子模块数过多 | 减少子模块数量 |
| 17 | 0x11 | 喷印已启动 | 先停止再启动 |
| 18 | 0x12 | 喷印未启动 | 先启动喷印 |
| 253 | 0xFD | 服务到期 | 联系供应商续费 |
| 255 | 0xFF | 喷码机锁定 | 发送解锁命令(0x03) |

### 常见错误及解决方法

**0x08 - 无效校验码**
- 原因：数据传输错误或校验码计算错误
- 解决：重新发送命令，检查网络稳定性

**0x0A - 解析失败**
- 原因：二维码模块数据格式不符合协议
- 解决：检查线条宽度、容错级别等参数

**0x12 - 喷印未启动**
- 原因：发送打印命令时喷印未启动
- 解决：先点击"启动喷印"，再发送打印

**0xFF - 喷码机锁定**
- 原因：喷码机处于锁定保护状态
- 解决：在调试面板发送解锁命令（0x03）

---

## 性能问题

### 问题：页面响应慢

**解决方法**：

1. **减少状态轮询频率**
   - 当前默认20秒查询一次
   - 墨盒余量改为手动刷新

2. **清理通信日志**
   - 刷新页面清空日志
   - 日志自动保留最近50条

3. **优化网络**
   - 使用有线网络连接
   - 减少网络延迟

---

## 调试技巧

### 1. 使用通信日志

通信日志是诊断问题的最重要工具：

**查看发送命令**：
- 点击展开查看完整协议解析
- 检查机号、命令ID、数据是否正确
- 验证校验码计算

**查看接收响应**：
- 检查状态码判断是否成功
- 查看返回数据了解执行结果
- 状态码非0x00时查看错误说明

### 2. 使用调试面板

调试面板提供所有TIJ协议命令：

1. 测试连接：发送握手命令（0x00）
2. 查询状态：发送获取报警状态（0x14）
3. 测试打印：发送触发喷印（0x13）
4. 检查墨盒：发送获取墨盒余量（0x26）

### 3. 查看服务器日志

```bash
# 启动开发服务器查看详细日志
npm run dev

# 关键日志标记
[v0] - 系统日志
[v0] Command breakdown: - 命令详细信息
[v0] Parsed response: - 响应解析
[v0] CPU Temperature: - CPU温度读取
```

### 4. 常用调试命令

```bash
# 网络诊断
ping 169.254.59.119                    # 测试网络连通性
telnet 169.254.59.119 139              # 测试TCP端口
netstat -an | grep 139                 # 查看端口状态

# GPIO诊断
gpio readall                           # 查看所有GPIO状态
gpio -g mode 20 out                    # 设置GPIO模式
gpio -g write 20 1                     # 设置GPIO输出

# 系统诊断
cat /sys/class/thermal/thermal_zone0/temp   # 读取CPU温度
sudo systemctl status pigpiod          # 检查pigpio服务
journalctl -u pigpiod -n 50            # 查看pigpio日志
```

---

## 获取帮助

如果以上方法都无法解决问题：

1. **导出通信日志**
   - 复制完整的通信日志记录
   - 包括发送和接收的完整数据

2. **记录错误信息**
   - 浏览器控制台错误（F12）
   - 服务器终端日志
   - 具体的操作步骤

3. **检查环境信息**
   ```bash
   # 树莓派型号
   cat /proc/device-tree/model
   
   # 系统版本
   uname -a
   
   # Node.js版本
   node --version
   ```

4. **查阅文档**
   - [TIJ协议文档](docs/TIJ_通讯协议6.6无屏机.pdf)
   - [API文档](./API_DOCUMENTATION.md)
   - [安装指南](./INSTALL.md)

5. **创建Issue**
   - 提供详细的错误信息
   - 包含复现步骤
   - 附上相关日志

---

## 预防措施

### 正确的操作流程

1. **首次使用**：
   ```
   配置设置 → 保存设置 → 连接喷码机 → 发送握手命令测试
   ```

2. **打印流程**：
   ```
   编辑内容 → 发送打印 → 启动喷印 → (等待光眼触发或手动触发)
   ```

3. **停止打印**：
   ```
   停止喷印 → 断开连接
   ```

### 注意事项

- ⚠️ **机号必须正确**：这是最容易出错的地方
- ⚠️ **先发送内容再启动**：顺序不能颠倒
- ⚠️ **检查墨盒余量**：余量不足会影响打印质量
- ⚠️ **保持网络稳定**：网络不稳定会导致通信失败
- ⚠️ **GPIO权限正确**：确保pigpio服务运行正常

---

**需要更多帮助？** 

查看 [API_DOCUMENTATION.md](./API_DOCUMENTATION.md) 了解详细的接口说明，或查看 [INSTALL.md](./INSTALL.md) 了解完整的安装和配置步骤。
