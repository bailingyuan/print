# 硬件连接指南

本文档详细说明喷码机控制系统的硬件连接方法。

## 系统架构图

```
┌─────────────────┐
│   树莓派主板    │
│                 │
│  ┌───────────┐  │
│  │  Next.js  │  │
│  │   应用    │  │
│  └─────┬─────┘  │
│        │        │
│  ┌─────┴─────┐  │
│  │ Serial+GPIO│ │
│  └─────┬─────┘  │
└────────┼────────┘
         │
    ┌────┴────┐
    │         │
┌───┴───┐ ┌──┴────┐
│喷码机 │ │步进   │
│(RS232)│ │电机   │
└───────┘ └───────┘
```

## 1. 喷码机连接

### 1.1 硬件需求
- USB转RS232转换器 (支持FTDI芯片)
- RS232串口线
- TIJ喷码机

### 1.2 连接步骤

1. **连接USB转RS232转换器到树莓派**
   ```
   树莓派 USB端口 → USB转RS232转换器
   ```

2. **连接串口线**
   ```
   USB转RS232转换器 → RS232串口线 → 喷码机串口
   ```

3. **确认设备识别**
   ```bash
   # 查看串口设备
   ls -l /dev/ttyUSB*
   
   # 应显示类似:
   # /dev/ttyUSB0
   ```

### 1.3 喷码机设置

在喷码机界面设置以下参数:

**机器参数 → 通讯设置 → 串口设置**
- 波特率: 115200
- 停止位: 1
- 校验位: 无
- 数据位: 8
- 机号: 0

## 2. 步进电机连接

### 2.1 硬件需求
- 42步进电机 (NEMA17)
- 步进电机驱动器 (A4988/DRV8825)
- 5V/12V电源适配器 (根据驱动器要求)
- 杜邦线若干

### 2.2 驱动器接线图

```
步进电机驱动器 (A4988)
┌─────────────────────────┐
│  VDD    GND    VMOT     │ ← 电源输入
│   │      │       │      │
│   5V    GND    12V      │
│                         │
│  EN     DIR    STEP     │ ← 控制信号
│   │      │       │      │
│ GPIO16 GPIO20 GPIO21    │ ← 树莓派GPIO
│                         │
│  1A  1B    2A    2B     │ ← 电机连接
│   │   │     │     │     │
│   └───┴─────┴─────┘     │
│          │              │
│      步进电机            │
└─────────────────────────┘
```

### 2.3 详细连接表

| 驱动器引脚 | 连接到 | 说明 |
|-----------|--------|------|
| VDD | 树莓派 5V (Pin 2) | 逻辑电源 |
| GND | 树莓派 GND (Pin 6) | 公共地 |
| VMOT | 12V电源 + | 电机电源 |
| GND | 12V电源 - | 电源地 |
| EN | GPIO 16 (Pin 36) | 使能控制 (低电平有效) |
| DIR | GPIO 20 (Pin 38) | 方向控制 |
| STEP | GPIO 21 (Pin 40) | 步进脉冲 |
| 1A, 1B | 电机线圈A | 电机A相 |
| 2A, 2B | 电机线圈B | 电机B相 |

### 2.4 树莓派GPIO引脚图

```
树莓派 40-Pin GPIO (顶视图)
    3V3  (1) (2)  5V  ← 5V供电
  GPIO2  (3) (4)  5V
  GPIO3  (5) (6)  GND  ← GND接地
  GPIO4  (7) (8)  GPIO14
    GND  (9) (10) GPIO15
 GPIO17 (11) (12) GPIO18
 GPIO27 (13) (14) GND
 GPIO22 (15) (16) GPIO23
    3V3 (17) (18) GPIO24
 GPIO10 (19) (20) GND
  GPIO9 (21) (22) GPIO25
 GPIO11 (23) (24) GPIO8
    GND (25) (26) GPIO7
  GPIO0 (27) (28) GPIO1
  GPIO5 (29) (30) GND
  GPIO6 (31) (32) GPIO12
 GPIO13 (33) (34) GND
 GPIO19 (35) (36) GPIO16  ← EN (使能)
 GPIO26 (37) (38) GPIO20  ← DIR (方向)
    GND (39) (40) GPIO21  ← STEP (步进)
```

### 2.5 连接步骤

1. **断电操作**: 确保树莓派和驱动器都已断电

2. **连接电源**:
   ```
   5V电源 → 驱动器VDD + 树莓派GND → 驱动器GND
   12V电源 → 驱动器VMOT + 12V GND → 驱动器GND
   ```

3. **连接控制信号**:
   ```
   树莓派 GPIO16 (Pin 36) → 驱动器 EN
   树莓派 GPIO20 (Pin 38) → 驱动器 DIR
   树莓派 GPIO21 (Pin 40) → 驱动器 STEP
   树莓派 GND (Pin 39)    → 驱动器 GND
   ```

4. **连接电机**:
   ```
   步进电机四根线 → 驱动器 1A, 1B, 2A, 2B
   (按电机手册接线)
   ```

### 2.6 驱动器配置

**A4988 微步设置** (通过MS1, MS2, MS3引脚):

| MS1 | MS2 | MS3 | 微步数 |
|-----|-----|-----|--------|
| L   | L   | L   | 全步   |
| H   | L   | L   | 1/2步  |
| L   | H   | L   | 1/4步  |
| H   | H   | L   | 1/8步  |
| H   | H   | H   | 1/16步 |

建议设置: **1/8步** (平衡精度和速度)

## 3. 供电方案

### 3.1 推荐配置

**方案A: 分离供电 (推荐)**
```
┌──────────┐
│ 5V 3A    │ → 树莓派 (USB-C供电)
└──────────┘

┌──────────┐
│ 12V 2A   │ → 步进电机驱动器
└──────────┘
```

**方案B: 共地供电**
```
┌──────────────────┐
│  多路电源        │
│  - 5V 3A         │ → 树莓派
│  - 12V 2A        │ → 驱动器
│  - 共地 (GND)    │
└──────────────────┘
```

### 3.2 电源要求

- **树莓派**: 5V 3A (USB-C)
- **步进电机驱动器**: 12V 2A (取决于电机规格)
- **建议使用稳压电源**，避免电压波动

## 4. 安全检查清单

在通电前，请检查:

- [ ] 所有连接牢固，无松动
- [ ] 电源极性正确 (正负极不能接反)
- [ ] GPIO引脚连接正确，无短路
- [ ] 步进电机接线正确
- [ ] 公共地(GND)已正确连接
- [ ] 驱动器散热片已安装 (如需要)
- [ ] 周围无易燃物品

## 5. 测试步骤

### 5.1 基础测试

1. **单独测试喷码机**:
   ```bash
   # 安装串口测试工具
   sudo apt-get install minicom
   
   # 打开串口测试
   minicom -D /dev/ttyUSB0 -b 115200
   ```

2. **单独测试步进电机**:
   ```bash
   # 测试GPIO
   gpio readall
   
   # 运行测试脚本
   sudo pigpiod
   npm run test:stepper
   ```

### 5.2 集成测试

启动完整系统:
```bash
npm run dev
```

访问 `http://树莓派IP:3000` 测试所有功能

## 6. 故障排除

### 6.1 喷码机通信失败

**症状**: 无法连接喷码机

**排查**:
1. 检查串口线连接
2. 确认设备路径: `ls -l /dev/ttyUSB*`
3. 检查波特率设置
4. 测试串口: `sudo chmod 666 /dev/ttyUSB0`

### 6.2 步进电机不转

**症状**: 电机无响应或只有声音不转动

**排查**:
1. 检查电源电压是否充足
2. 确认EN引脚为低电平 (使能)
3. 检查电机接线是否正确
4. 调整驱动器电流限制 (顺时针旋转电位器)
5. 确认pigpio守护进程运行: `sudo pigpiod`

### 6.3 电机发热严重

**症状**: 电机温度过高

**解决**:
1. 调整驱动器电流限制 (逆时针降低)
2. 增加散热片
3. 改善通风环境
4. 检查是否长时间保持力矩 (考虑使能控制)

## 7. 维护建议

### 日常维护
- 定期检查接线是否松动
- 清理灰尘，保持通风
- 检查电源输出电压是否稳定

### 定期保养
- 每月检查步进电机轴承
- 每季度清洁电路板
- 半年检查驱动器散热
- 年检所有连接器和线缆

---

**警告**: 
- 操作前务必断电
- 不要在带电情况下插拔连接
- 注意防止静电损坏元件
- 确保通风良好，防止过热
```

这个完整的喷码机控制系统已经创建完成！系统包括:

1. **功能实现**:
   - ✅ 网页输入URL和数量生成二维码打印
   - ✅ 42步进电机控制导轨移动
   - ✅ 实时监控喷头状态、墨盒余量、CPU温度
   - ✅ 美观的通信日志显示(发送/接收一一对应)

2. **技术特点**:
   - 基于TIJ协议实现完整的串口通信
   - GPIO控制步进电机(支持方向、步进、使能)
   - 实时状态刷新和日志记录
   - 美观的界面设计和数据可视化

3. **完整文档**:
   - README.md: 完整的API文档和使用说明
   - HARDWARE_SETUP.md: 详细的硬件连接指南

系统已准备就绪，可以部署到树莓派上使用！
